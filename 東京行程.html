<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>東京 & 野澤溫泉 - 互動行程儀表板</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #0f172a; /* Slate 900 */
            color: #e2e8f0;
        }
        .glass-panel {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(148, 163, 184, 0.1);
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .map-canvas-container {
            background-image: radial-gradient(#1e293b 1px, transparent 1px);
            background-size: 20px 20px;
            background-color: #020617;
        }
        
        /* Custom Range Slider */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #38bdf8;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #334155;
            border-radius: 2px;
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- Data Extraction from User Document ---
        // Mocking specific train times based on the provided text
        const itineraryData = [
            {
                id: 1,
                date: "2025-02-15",
                day: "週六",
                title: "抵達東京 & 上野過境",
                summary: "成田機場入境，搭乘 Skyliner 直達上野，入住相鐵 Fresa Inn。",
                locations: ["Narita", "Ueno"],
                stay: "相鐵 Fresa Inn 上野御徒町",
                highlights: ["京成 Skyliner", "阿美橫丁晚餐", "Yamashiroya 玩具店"],
                transport_type: "train",
                schedule: [
                    { time: "17:00", name: "Skyliner 56號", route: "成田 T1 -> 京成上野", duration: "44分" },
                    { time: "17:20", name: "Skyliner 58號", route: "成田 T1 -> 京成上野", duration: "44分" },
                    { time: "17:39", name: "Skyliner 60號", route: "成田 T1 -> 京成上野", duration: "44分" },
                    { time: "17:59", name: "Skyliner 62號", route: "成田 T1 -> 京成上野", duration: "44分" },
                    { time: "18:15", name: "Skyliner 64號", route: "成田 T1 -> 京成上野", duration: "45分" },
                    { time: "18:40", name: "Skyliner 66號", route: "成田 T1 -> 京成上野", duration: "44分" },
                    { time: "19:00", name: "Skyliner 68號", route: "成田 T1 -> 京成上野", duration: "45分" },
                    { time: "19:20", name: "Skyliner 70號", route: "成田 T1 -> 京成上野", duration: "44分" },
                ]
            },
            {
                id: 2,
                date: "2025-02-16",
                day: "週日",
                title: "前進雪國：野澤溫泉",
                summary: "北陸新幹線 Hakutaka 轉乘 Nozawa Onsen Liner 巴士。",
                locations: ["Ueno", "Iiyama", "Nozawa"],
                stay: "野澤溫泉旅館",
                highlights: ["北陸新幹線 Hakutaka", "野澤溫泉 Liner", "雪具租賃 St. Anton", "溫泉街晚餐"],
                transport_type: "shinkansen",
                schedule: [
                    { time: "06:34", name: "Hakutaka 551", route: "上野 -> 飯山", duration: "1h 42m (早鳥)" },
                    { time: "07:58", name: "Hakutaka 553", route: "上野 -> 飯山", duration: "1h 41m (推薦)", recommended: true },
                    { time: "08:25", name: "Nozawa Liner", route: "飯山站 -> 野澤溫泉", duration: "25分" },
                    { time: "08:50", name: "Hakutaka 555", route: "上野 -> 飯山", duration: "1h 47m" },
                    { time: "09:34", name: "Hakutaka 557", route: "上野 -> 飯山", duration: "1h 46m" },
                    { time: "09:50", name: "Nozawa Liner", route: "飯山站 -> 野澤溫泉", duration: "25分" },
                    { time: "10:40", name: "Nozawa Liner", route: "飯山站 -> 野澤溫泉", duration: "25分" },
                ]
            },
            {
                id: 3,
                date: "2025-02-17 ~ 19",
                day: "週一~三",
                title: "野澤溫泉全日滑雪",
                summary: "享受粉雪與溫泉的極致體驗。",
                locations: ["Nozawa"],
                stay: "野澤溫泉旅館",
                highlights: ["日影滑雪場", "長坂纜車", "外湯巡禮", "Trattoria Bivacco 晚餐"],
                transport_type: "none", // No major inter-city travel
                schedule: [
                    { time: "08:00", name: "長坂纜車運行開始", route: "山麓 -> 山頂", duration: "-" },
                    { time: "08:30", name: "滑雪課程集合", route: "日影滑雪中心", duration: "-" },
                    { time: "17:00", name: "夜滑開始", route: "長坂區域", duration: "至20:00" },
                ]
            },
            {
                id: 4,
                date: "2025-02-20",
                day: "週四",
                title: "返回東京 & 八丁堀入住",
                summary: "告別雪國，移動至東京八丁堀公寓式酒店。",
                locations: ["Nozawa", "Iiyama", "Ueno", "Hatchobori"],
                stay: "MIMARU 東京八丁堀",
                highlights: ["Nozawa Liner", "新幹線返程", "超市採買"],
                transport_type: "shinkansen",
                schedule: [
                    { time: "09:40", name: "Nozawa Liner", route: "野澤 -> 飯山", duration: "25分" },
                    { time: "10:28", name: "Hakutaka 556", route: "飯山 -> 上野", duration: "1h 45m" },
                    { time: "11:25", name: "Hakutaka 558", route: "飯山 -> 上野", duration: "1h 45m" },
                    { time: "13:20", name: "日比谷線", route: "上野 -> 八丁堀", duration: "12分" },
                ]
            },
            {
                id: 5,
                date: "2025-02-21",
                day: "週五",
                title: "分眾行程：動漫 & 高爾夫",
                summary: "兵分兩路：台場鋼彈/秋葉原 vs 銀座高爾夫球具。",
                locations: ["Hatchobori", "Odaiba", "Akihabara", "Ginza"],
                stay: "MIMARU 東京八丁堀",
                highlights: ["Gundam Base (需抽選)", "Radio Kaikan", "Double Eagle Ginza", "Victoria Golf 神田"],
                transport_type: "metro",
                schedule: [
                    { time: "10:00", name: "Gundam Base", route: "開店 (台場)", duration: "預約制" },
                    { time: "11:00", name: "Double Eagle", route: "開店 (銀座)", duration: "Fitting預約" },
                    { time: "13:00", name: "日比谷線", route: "八丁堀 -> 秋葉原", duration: "12分" },
                    { time: "19:00", name: "晚餐會合", route: "八丁堀周邊", duration: "-" },
                ]
            },
            {
                id: 6,
                date: "2025-02-22",
                day: "週六",
                title: "包車返程",
                summary: "滿載戰利品，搭乘包車直達成田機場。",
                locations: ["Hatchobori", "Narita"],
                stay: "溫暖的家",
                highlights: ["Toyota Hiace 包車", "最後補貨", "返台"],
                transport_type: "car",
                schedule: [
                    { time: "10:00", name: "退房", route: "MIMARU", duration: "-" },
                    { time: "13:00", name: "包車出發", route: "飯店 -> 成田機場", duration: "90-120分" },
                    { time: "15:00", name: "抵達機場", route: "成田 T1/T2", duration: "-" },
                ]
            },
        ];

        // Coordinates for Map Visualization (Relative 0-100 scale)
        const mapCoords = {
            Narita: { x: 85, y: 80, label: "成田機場" },
            Ueno: { x: 60, y: 75, label: "上野" },
            Hatchobori: { x: 62, y: 78, label: "八丁堀" },
            TokyoStn: { x: 60, y: 80, label: "東京站" },
            Odaiba: { x: 62, y: 85, label: "台場" },
            Akihabara: { x: 60, y: 72, label: "秋葉原" },
            Ginza: { x: 58, y: 79, label: "銀座" },
            Iiyama: { x: 30, y: 30, label: "飯山站" },
            Nozawa: { x: 35, y: 20, label: "野澤溫泉" },
        };

        // Helper: Parse time string "HH:MM" to minutes
        const timeToMins = (timeStr) => {
            const [h, m] = timeStr.split(":").map(Number);
            return h * 60 + m;
        };

        const minsToTime = (mins) => {
            let h = Math.floor(mins / 60);
            let m = mins % 60;
            if (h >= 24) h -= 24;
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        };

        // Component: Timeline Slider
        const TimeSlider = ({ currentTime, setTime }) => {
            return (
                <div className="p-4 glass-panel rounded-xl mb-4">
                    <div className="flex justify-between items-end mb-2">
                        <span className="text-gray-400 text-sm font-mono">CURRENT TIME</span>
                        <span className="text-3xl font-bold text-sky-400 font-mono">{minsToTime(currentTime)}</span>
                    </div>
                    <input 
                        type="range" 
                        min="360" // 06:00
                        max="1320" // 22:00
                        step="10"
                        value={currentTime} 
                        onChange={(e) => setTime(parseInt(e.target.value))}
                        className="w-full"
                    />
                    <div className="flex justify-between text-xs text-gray-500 mt-2">
                        <span>06:00</span>
                        <span>12:00</span>
                        <span>18:00</span>
                        <span>22:00</span>
                    </div>
                </div>
            );
        };

        // Component: Upcoming Schedule
        const UpcomingSchedule = ({ schedule, currentTime }) => {
            const windowSize = 120; // 2 hours
            
            const filtered = schedule.filter(item => {
                const itemTime = timeToMins(item.time);
                return itemTime >= currentTime && itemTime <= currentTime + windowSize;
            });

            return (
                <div className="glass-panel rounded-xl p-4 h-full flex flex-col">
                    <h3 className="text-lg font-bold mb-4 flex items-center gap-2 text-sky-300">
                        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                        2小時內車次時刻表
                    </h3>
                    
                    <div className="overflow-y-auto flex-1 pr-2">
                        {filtered.length === 0 ? (
                            <div className="text-center text-gray-500 py-8 italic">
                                此時段暫無表定行程<br/>請拖動上方時間滑桿
                            </div>
                        ) : (
                            <div className="space-y-3">
                                {filtered.map((item, idx) => (
                                    <div key={idx} className={`p-3 rounded-lg border-l-4 ${item.recommended ? 'bg-sky-900/30 border-sky-400' : 'bg-slate-800/50 border-slate-600'}`}>
                                        <div className="flex justify-between items-center mb-1">
                                            <span className="text-xl font-bold font-mono text-white">{item.time}</span>
                                            {item.recommended && <span className="bg-sky-600 text-white text-[10px] px-2 py-0.5 rounded-full">推薦</span>}
                                        </div>
                                        <div className="font-semibold text-sky-100">{item.name}</div>
                                        <div className="flex justify-between text-sm text-gray-400 mt-1">
                                            <span>{item.route}</span>
                                            <span>{item.duration}</span>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // Component: Map Canvas
        const MapCanvas = ({ dayData }) => {
            const canvasRef = useRef(null);
            const animationRef = useRef(null);

            useEffect(() => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                
                // Resize handler
                const resize = () => {
                    const parent = canvas.parentElement;
                    canvas.width = parent.clientWidth;
                    canvas.height = parent.clientHeight;
                };
                resize();
                window.addEventListener('resize', resize);

                // Drawing loop
                let progress = 0;
                
                const drawMap = () => {
                    const w = canvas.width;
                    const h = canvas.height;
                    
                    ctx.clearRect(0, 0, w, h);

                    // 1. Draw Background (Abstract Japan Shape placeholder or just grid)
                    // For this immersive, we use the grid css, so just draw nodes/lines
                    
                    // 2. Draw All Nodes (Faded)
                    Object.entries(mapCoords).forEach(([key, val]) => {
                        ctx.beginPath();
                        ctx.arc(val.x * w / 100, val.y * h / 100, 4, 0, Math.PI * 2);
                        ctx.fillStyle = "#334155";
                        ctx.fill();
                        
                        // Labels
                        ctx.fillStyle = "#475569";
                        ctx.font = "10px Arial";
                        ctx.fillText(val.label, val.x * w / 100 + 8, val.y * h / 100 + 3);
                    });

                    // 3. Draw Active Route
                    const activeLocs = dayData.locations;
                    if (activeLocs.length > 1) {
                        ctx.beginPath();
                        ctx.strokeStyle = "#38bdf8";
                        ctx.lineWidth = 3;
                        ctx.setLineDash([5, 5]);

                        // Draw static path
                        ctx.moveTo(mapCoords[activeLocs[0]].x * w / 100, mapCoords[activeLocs[0]].y * h / 100);
                        for(let i=1; i<activeLocs.length; i++) {
                            const target = mapCoords[activeLocs[i]];
                            ctx.lineTo(target.x * w / 100, target.y * h / 100);
                        }
                        ctx.stroke();
                        ctx.setLineDash([]);

                        // 4. Animate Moving Dot
                        // Calculate total path segments
                        const totalSegments = activeLocs.length - 1;
                        const segmentProgress = (Date.now() / 2000) % totalSegments; // Cycle every 2s per segment approx
                        const currentSegmentIdx = Math.floor(segmentProgress);
                        const t = segmentProgress - currentSegmentIdx;

                        const startNode = mapCoords[activeLocs[currentSegmentIdx]];
                        const endNode = mapCoords[activeLocs[currentSegmentIdx + 1]];

                        if (startNode && endNode) {
                            const curX = startNode.x + (endNode.x - startNode.x) * t;
                            const curY = startNode.y + (endNode.y - startNode.y) * t;

                            // Draw Moving Dot
                            ctx.beginPath();
                            ctx.arc(curX * w / 100, curY * h / 100, 6, 0, Math.PI * 2);
                            ctx.fillStyle = "#facc15"; // Yellow
                            ctx.shadowColor = "#facc15";
                            ctx.shadowBlur = 10;
                            ctx.fill();
                            ctx.shadowBlur = 0;

                            // Draw Ripple
                            ctx.beginPath();
                            ctx.arc(curX * w / 100, curY * h / 100, 6 + (t * 10), 0, Math.PI * 2);
                            ctx.strokeStyle = `rgba(250, 204, 21, ${1-t})`;
                            ctx.stroke();
                        }
                    }

                    // Highlight Active Nodes
                    activeLocs.forEach(locKey => {
                        const node = mapCoords[locKey];
                        if(node) {
                            ctx.beginPath();
                            ctx.arc(node.x * w / 100, node.y * h / 100, 6, 0, Math.PI * 2);
                            ctx.fillStyle = "#38bdf8"; // Sky Blue
                            ctx.fill();
                            
                            ctx.fillStyle = "#e2e8f0";
                            ctx.font = "bold 12px Arial";
                            ctx.fillText(node.label, node.x * w / 100 + 10, node.y * h / 100 + 4);
                        }
                    });

                    animationRef.current = requestAnimationFrame(drawMap);
                };

                drawMap();

                return () => {
                    window.removeEventListener('resize', resize);
                    cancelAnimationFrame(animationRef.current);
                };
            }, [dayData]);

            return <canvas ref={canvasRef} className="w-full h-full block" />;
        };

        // Main App Component
        const App = () => {
            const [selectedDayId, setSelectedDayId] = useState(2); // Default to Feb 16 (Travel day)
            const [currentTime, setCurrentTime] = useState(480); // 08:00 AM in minutes

            const currentDayData = useMemo(() => 
                itineraryData.find(d => d.id === selectedDayId), 
                [selectedDayId]
            );

            return (
                <div className="min-h-screen p-4 md:p-6 max-w-7xl mx-auto flex flex-col gap-4">
                    
                    {/* Header */}
                    <header className="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-2">
                        <div>
                            <h1 className="text-2xl md:text-3xl font-bold bg-gradient-to-r from-sky-400 to-indigo-400 bg-clip-text text-transparent">
                                東京 & 野澤溫泉之旅
                            </h1>
                            <p className="text-gray-400 text-sm">2025年2月15日 - 2月22日 | 行程視覺化與物流分析</p>
                        </div>
                        <div className="flex items-center gap-2 bg-slate-800 rounded-lg p-1">
                            {itineraryData.map(day => (
                                <button
                                    key={day.id}
                                    onClick={() => {
                                        setSelectedDayId(day.id);
                                        // Reset time based on day type for better UX
                                        if(day.id === 1) setCurrentTime(1020); // 17:00
                                        else if(day.id === 2) setCurrentTime(450); // 07:30
                                        else setCurrentTime(540); // 09:00
                                    }}
                                    className={`px-3 py-1.5 text-xs md:text-sm rounded-md transition-all ${
                                        selectedDayId === day.id 
                                        ? 'bg-sky-600 text-white font-bold shadow-lg' 
                                        : 'text-gray-400 hover:bg-slate-700 hover:text-white'
                                    }`}
                                >
                                    {day.date.slice(5).replace('-','/')}
                                </button>
                            ))}
                        </div>
                    </header>

                    {/* Main Grid */}
                    <div className="grid grid-cols-1 lg:grid-cols-12 gap-4 flex-1 min-h-[600px]">
                        
                        {/* Left Column: Details & Time Control (4 cols) */}
                        <div className="lg:col-span-4 flex flex-col gap-4">
                            
                            {/* Day Summary Card */}
                            <div className="glass-panel p-5 rounded-2xl border-l-4 border-sky-500">
                                <div className="flex justify-between items-center mb-2">
                                    <span className="text-sky-400 font-bold tracking-wider text-sm">{currentDayData.date} ({currentDayData.day})</span>
                                    <span className="bg-slate-700 text-xs px-2 py-1 rounded text-gray-300">{currentDayData.transport_type.toUpperCase()}</span>
                                </div>
                                <h2 className="text-2xl font-bold text-white mb-3">{currentDayData.title}</h2>
                                <p className="text-gray-300 text-sm leading-relaxed mb-4">{currentDayData.summary}</p>
                                
                                <div className="space-y-2">
                                    <div className="flex items-start gap-3">
                                        <div className="bg-indigo-900/50 p-1.5 rounded mt-0.5">
                                            <svg className="w-4 h-4 text-indigo-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"></path></svg>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-400">住宿</div>
                                            <div className="text-sm font-medium text-white">{currentDayData.stay}</div>
                                        </div>
                                    </div>
                                    <div className="flex items-start gap-3">
                                        <div className="bg-emerald-900/50 p-1.5 rounded mt-0.5">
                                            <svg className="w-4 h-4 text-emerald-300" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M5 3v4M3 5h4M6 17v4m-2-2h4m5-16l2.286 6.857L21 12l-5.714 2.143L13 21l-2.286-6.857L5 12l5.714-2.143L13 3z"></path></svg>
                                        </div>
                                        <div>
                                            <div className="text-xs text-gray-400">今日重點</div>
                                            <div className="flex flex-wrap gap-1 mt-1">
                                                {currentDayData.highlights.map((tag, i) => (
                                                    <span key={i} className="text-xs bg-slate-700/50 px-2 py-0.5 rounded text-slate-200 border border-slate-600">{tag}</span>
                                                ))}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {/* Time Slider */}
                            <TimeSlider currentTime={currentTime} setTime={setCurrentTime} />

                            {/* Timetable */}
                            <div className="flex-1 min-h-[200px]">
                                <UpcomingSchedule schedule={currentDayData.schedule} currentTime={currentTime} />
                            </div>
                        </div>

                        {/* Right Column: Map Visual (8 cols) */}
                        <div className="lg:col-span-8 relative group rounded-2xl overflow-hidden border border-slate-700 shadow-2xl">
                            
                            {/* Map Canvas */}
                            <div className="absolute inset-0 map-canvas-container">
                                <MapCanvas dayData={currentDayData} />
                            </div>

                            {/* Map Overlay Info */}
                            <div className="absolute top-4 right-4 glass-panel p-3 rounded-lg max-w-xs">
                                <div className="text-xs text-gray-400 uppercase tracking-wider mb-1">移動概況</div>
                                <div className="flex items-center gap-2">
                                    <div className="w-2 h-2 rounded-full bg-sky-400 animate-pulse"></div>
                                    <span className="text-sm font-bold">
                                        {currentDayData.locations.join(' → ')}
                                    </span>
                                </div>
                            </div>

                            <div className="absolute bottom-4 left-4 right-4 pointer-events-none">
                                <div className="bg-black/60 backdrop-blur-md text-xs text-gray-400 p-2 rounded text-center border border-white/10">
                                    ＊圖示為相對位置示意，非精確地理座標。請以 Google Maps 導航為準。
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>